# Configuring iOS DeviceCheck

To verify device integrity, Apple provides a service called [DeviceCheck][dc].
This service is most commonly used to store per-developer bits, but it can also
be used to verify the legitimacy of an iOS device.

As part of the DeviceCheck process, the server receives a `deviceToken` from a
verified iOS device. This token is generated by a client application see the
[DeviceCheck docs][dc] for information on how to generate this token in your
app. Note that the token is generated on the _client_. The _server_ does not
generate this token, but it does validate it's authenticity.

When the server receives the `deviceToken`, it needs to communicate with Apple's
servers to verify the authenticity of the token. This request requires
authentication and authorization. Authentication is provided via a signed JWT
and authorization is provided based on the grants given to the signing key. The
server automatically constructs and signs these JWTs, but you must provide the
signing keys.

Each _team_ requires a different key for verification. If you are running a
multi-tenant server that supports iOS apps from multiple developers, you will
need to acquire and register DeviceCheck for _each_ team.


## Getting the Team ID

The DeviceCheck API requires you to specify your Team ID. **This requires a
valid and active iOS Apple developer subscription.**

1.  Visit https://developer.apple.com/account/#/membership and sign in to your
    developer account.

1.  Find the value for "Team ID" in the table on this page - this is usually a
    10 character alpha-numeric ID like `ABCDE1FGHI`.


## Generating the DeviceCheck Private Key

In order for the server to communicate with Apple's servers, you will need to
create an Apple authenticate key with `DeviceCheck` enabled. **This requires a
valid and active iOS Apple developer subscription.**

1.  Visit https://developer.apple.com/account/resources and sign in to your
    developer account.

1.  Choose "Keys" in the side menu.

1.  Click the add button to create a new key.

1.  On the next page, enter a name for the key. This name is only for you to
    identify the key, so give it a descriptive name. You will not use the key
    name in later steps.

1.  Check the box next to "DeviceCheck" to enable using the DeviceCheck with
    this key.

1.  Click "Continue".

1.  On the success page, take **both** of the following actions:

    1.  Save the DeviceCheck Key ID value to a secure location - this is usually
        a 10 character alpha-numeric ID like `1BC2D3EFG4`.

    1.  Download the DeviceCheck Private Key file (`.p8`) and save it in a
        secure location. **This file is a private key, so treat it like a
        password.**


## Configuring DeviceCheck in the server

To enable and configure Apple's DeviceCheck on the server, you must specify the
following information for _each_ iOS application your server supports:

- **Team ID** - developer ID, used as the `iss` in the JWT.

- **Key ID** - key ID, used as the `kid` in the JWT.

- **Private Key** - private key (`.p8`), used to sign the JWT.


## Sharing with server operators

You need to share these values with your server operator. If your server is
operated by a third party, the preferred way to share these secrets is using
[Secret Manager][sm]. The secret resides in a Google Cloud project that you
control, and you can revoke access to the secret at any time.

**You will need:**

-   A [Google Cloud account][gcp-signup] and a [project][create-project]. You
    will need the project's ID (`$PROJECT_ID`) in future steps, so note it.

-   The [gcloud][gcloud] command line tool.

-   Your Team ID, Key ID, and Private Key in .p8 format. These values come from
    the Apple Developer Portal using the instructions above.

-   The server operator's service account email. Your server operator will share
    this value. This will be of the form `name@project.iam.gserviceaccount.com`.

You should already have a communicate channel with your server operator like a
shared chat room, email, or conference bridge.

To share the DeviceCheck Private Key with a server operator:

1.  If you have not already done so, authenticate the gcloud CLI:

    ```text
    $ gcloud auth login && gcloud auth application-default login
    ```

    This will open two browers and ask you to authenticate with your Google
    account. Use the same account which owns the Google Cloud project.

1.  Enable the Secret Manager service on your Google Cloud project:

    ```text
    $ gcloud services enable secretmanager.googleapis.com \
        --project "${PROJECT_ID}"
    ```

1.  Create a secret and upload the private key into the secret:

    ```text
    $ gcloud secrets create "devicecheck-key" \
        --project "${PROJECT_ID}" \
        --replication-policy "automatic" \
        --data-file ./key.p8 # <-- replace with the path to your key
    ```

1.  Grant the server's service account the ability to access the secret:

    ```text
    $ gcloud secrets add-iam-policy-binding "devicecheck-key" \
        --project "${PROJECT_ID}" \
        --role "roles/secretmanager.secretAccessor" \
        --member "[EMAIL]" # <-- replace with the value from the server operator
    ```

1.  Get the secret resource ID, for sharing with the server operator:

    ```
    $ gcloud secrets describe "1" \
        --project "${PROJECT_ID}" \
        --secret "devicecheck-key" \
        --format "value(name)"
    ```

    The result should look like:

    ```text
    projects/123456789/secrets/devicecheck-key/versions/1
    ```

1.  Using the existing communication channel with your server operator, share
    your:

    -   Team ID
    -   Key ID
    -   Private Key **Resource ID**


[dc]: https://developer.apple.com/documentation/devicecheck
[sm]: https://cloud.google.com/secret-manager.
[gcloud]: https://cloud.google.com/sdk/install
[gcp-signup]: https://console.cloud.google.com/freetrial
[create-project]: https://cloud.google.com/resource-manager/docs/creating-managing-projects
